---
title: "cleaning data"
author: "Thomas Delcey"
date: '2022-06-27'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

-   [1 What is this script for?](#what-is-this-script-for)
-   [2 Loading packages, paths and data](#loading-packages-paths-and-data)

# 1 What is this script for?


# 2 Loading packages, paths and
    data
    
```{r}

source("C:/Users/thomd/Documents/MEGA/github/ANR/script/0_paths_and_packages.R")

?list.files

file.list <- paste0(data_path, list.files(path = data_path, pattern='*.xlsx'))
df.list <- lapply(file.list, read_excel)

dgpie_partenaire_df <- df.list[[1]]
dgpie_projet_df <- df.list[[2]]
dos_partenaire_df <- df.list[[3]]
dos_projet_df <- df.list[[4]]
discipline_code_df <- df.list[[5]]

```

#Featurization
```{r}
library(sotu)
library(tidytext)
library(SnowballC) 
library(ldatuning)

summary <- dos_projet_df %>%
   filter(!is.na(Projet.Resume.Anglais)) %>% #filter projet with an english summary
   select(c(Projet.Code_Decision_ANR, Projet.Resume.Anglais, AAP.Edition)) %>%
   rename(text = Projet.Resume.Anglais,
          id = Projet.Code_Decision_ANR,
          year = AAP.Edition) %>% #renames variables 
   unnest_tokens(output = token, input = text) 
 #%>% # create token
  #anti_join(get_stopwords(), by = c("token" = "word")) %>% # stop word
  #mutate(token = wordStem(token, language = "en")) #stemming
```

#DTM 

```{r}
summary_dtm <- summary %>% 
   filter(str_length(token) 1) %>% 
   count(id, year, token) %>% 
   group_by(token) %>% 
   filter(n() < 95) %>% # remove tokens that appear in more than 95 documents (i.e., years) WHY ?
   cast_dtm(document = year, term = token, value = n)
```

#Finding k
```{r}

library(ldatuning)

determine_k <- FindTopicsNumber(
   summary_dtm,
   topics = seq(from = 2, to = 30, by = 1),
   metrics = c("Griffiths2004", "CaoJuan2009", "Arun2010", "Deveaud2014"),
   method = "Gibbs",
   control = list(seed = 77),
   mc.cores = 16L,
   verbose = TRUE
 )
```

```{r}
library(topicmodels)
library(broom)

summary_dtm_k13 <- LDA(summary_dtm, k = 20, control = list(seed = 77))

summary_dtm_k13_tidied <- tidy(summary_dtm_k13)

#write_rds(sotu_lda_k16, "lda_16.rds")
summary_dtm_k13_tidied %>% glimpse()

top_terms_k13 <- summary_dtm_k13_tidied %>%
   group_by(topic) %>%
   slice_max(beta, n = 10, with_ties = FALSE) %>%
   ungroup() %>%
   arrange(topic, -beta)

top_terms_k13 %>%
   mutate(topic = factor(topic),
          term = reorder_within(term, beta, topic)) %>%
   ggplot(aes(term, beta, fill = topic)) +
   geom_bar(stat = "identity", show.legend = FALSE) +
   scale_x_reordered() +
   facet_wrap(~topic, scales = "free", ncol = 4) +
   coord_flip()

```
